#!/bin/bash

usage() {
  cat << HELP
SYNOPSIS: tw-web [-n] <url> [<comment>]
  twit "TITLE URL"

OPTIONS
  -n  dry-run
HELP
  exit 0
}

get-title() {
    curl -s "$URL" | nkf |
    sed 's/TITLE/title/gi' |
    grep -A 100000 '<head' |
    grep -B 100000 '</head>' |
    grep -A 10 '<title>' |
    tr '\n' ' ' |
    sed 's,.*<title>\(.*\)</title>.*,\1,' |
    sed 's/^ *//g; s/ *$//g'
}

# globals
DRYRUN=0
URL=
MSG=

# parse args
while [ "_$1" != "_" ]; do
  case "$1" in
      -h | --help )
          usage
          ;;
      -n )
          DRYRUN=1
          shift
          ;;
      http://* | https://* )
          URL=$1
          shift
          ;;
      * )
          if [ "_$MSG" == "_" ]; then
              MSG="$1"
          else
              MSG="$MSG $1"
          fi
          ;;
  esac
done

# failed
if [ -z "$URL" ]; then
    usage
fi

# fetch title
TITLE=$(get-title "$1")

if [ "_$MSG" != "_" ]; then
    MSG="$MSG > "
else
    MSG=""
fi

if [ $DRYRUN -eq 0 ]; then
    tw "${COMMENT}${TITLE} ${URL}"
else
    echo tw "${COMMENT}${TITLE} ${URL}"
fi
